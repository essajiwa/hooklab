<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HookLab - Webhook Monitor & API Response Mocking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              ink: "#0c0d12",
              mist: "#eceff6",
              flare: "#ff7a59",
              lagoon: "#3ed8a6",
              night: "#121826",
            },
            fontFamily: {
              display: ["Playfair Display", "serif"],
              body: ["IBM Plex Sans", "sans-serif"],
            },
          },
        },
      };
    </script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600&family=Playfair+Display:wght@500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css" />
    <style>
      .CodeMirror {
        background: transparent !important;
        color: #eceff6 !important;
        font-family: ui-monospace, monospace !important;
        font-size: 0.75rem !important;
        height: 10rem !important;
      }
      .CodeMirror-scroll {
        overflow-y: auto !important;
        max-height: 16rem;
      }
      .CodeMirror-gutters {
        background: transparent !important;
        border-right: 1px solid rgba(255,255,255,0.1) !important;
      }
      .CodeMirror-linenumber {
        color: rgba(236,239,246,0.4) !important;
      }
      .CodeMirror-cursor {
        border-left-color: #ff7a59 !important;
      }
      .CodeMirror-selected {
        background: rgba(255,122,89,0.2) !important;
      }
      .cm-error {
        text-decoration: wavy underline red;
      }
      .json-error-msg {
        color: #ff6b6b;
        font-size: 0.7rem;
        margin-top: 0.5rem;
      }
      .github-ribbon {
        position: fixed;
        top: 0;
        right: 0;
        z-index: 50;
        width: 150px;
        height: 150px;
        overflow: hidden;
        pointer-events: none;
      }
      .github-ribbon a {
        pointer-events: auto;
        position: absolute;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        width: 200px;
        padding: 8px 0;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: #eceff6;
        font-size: 12px;
        font-weight: 500;
        text-decoration: none;
        text-align: center;
        transform: rotate(45deg);
        top: 35px;
        right: -50px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.1);
        transition: background 0.2s;
      }
      .github-ribbon a:hover {
        background: linear-gradient(135deg, #2a2a4e 0%, #1e2a4e 100%);
      }
      .github-ribbon svg {
        width: 16px;
        height: 16px;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-ink via-night to-ink text-mist font-body">
    <div class="github-ribbon">
      <a href="https://github.com/essajiwa/hooklab" target="_blank" rel="noopener noreferrer">
        <svg fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
        GitHub
      </a>
    </div>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/json-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonlint/1.6.0/jsonlint.min.js"></script>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;

      const getBaseUrl = () => {
        const { protocol, host } = window.location;
        return `${protocol}//${host}`;
      };

      const formatTime = (value) =>
        new Date(value).toLocaleTimeString(undefined, {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

      const formatBody = (value) => {
        if (!value) return "<empty body>";
        try {
          const parsed = JSON.parse(value);
          return JSON.stringify(parsed, null, 2);
        } catch (error) {
          return value;
        }
      };

      const methodColors = {
        GET: "border-lagoon/40 bg-lagoon/10 text-lagoon",
        POST: "border-flare/40 bg-flare/10 text-flare",
        PUT: "border-amber-400/40 bg-amber-400/10 text-amber-400",
        PATCH: "border-violet-400/40 bg-violet-400/10 text-violet-400",
        DELETE: "border-red-400/40 bg-red-400/10 text-red-400",
        HEAD: "border-cyan-400/40 bg-cyan-400/10 text-cyan-400",
        OPTIONS: "border-pink-400/40 bg-pink-400/10 text-pink-400",
      };

      const getMethodColor = (method) =>
        methodColors[method] || "border-mist/40 bg-mist/10 text-mist";

      function App() {
        const [events, setEvents] = useState([]);
        const [status, setStatus] = useState("Waiting for traffic...");
        const [responseBody, setResponseBody] = useState(
          '{\n  "result": "ok"\n}'
        );
        const [webhookKey, setWebhookKey] = useState(() => {
          const params = new URLSearchParams(window.location.search);
          return params.get('key') || 'default';
        });
        const [keyInput, setKeyInput] = useState('');
        const [knownKeys, setKnownKeys] = useState(() => {
          try {
            const stored = localStorage.getItem('hooklab_keys');
            return stored ? JSON.parse(stored) : ['default'];
          } catch (e) {
            return ['default'];
          }
        });
        const [saveState, setSaveState] = useState("");
        const [statusCode, setStatusCode] = useState(200);
        const editorRef = useRef(null);
        const editorScrollRef = useRef(null);
        const cmEditorRef = useRef(null);
        const cmInstanceRef = useRef(null);
        const [jsonError, setJsonError] = useState("");
        const statusOptions = [
          { code: 200, label: "200 OK" },
          { code: 201, label: "201 Created" },
          { code: 202, label: "202 Accepted" },
          { code: 204, label: "204 No Content" },
          { code: 301, label: "301 Moved Permanently" },
          { code: 302, label: "302 Found" },
          { code: 304, label: "304 Not Modified" },
          { code: 400, label: "400 Bad Request" },
          { code: 401, label: "401 Unauthorized" },
          { code: 403, label: "403 Forbidden" },
          { code: 404, label: "404 Not Found" },
          { code: 409, label: "409 Conflict" },
          { code: 422, label: "422 Unprocessable Entity" },
          { code: 429, label: "429 Too Many Requests" },
          { code: 500, label: "500 Internal Server Error" },
          { code: 502, label: "502 Bad Gateway" },
          { code: 503, label: "503 Service Unavailable" },
        ];

        const formattedEvents = useMemo(
          () => events.filter((event) => (webhookKey ? event.key === webhookKey : true)),
          [events, webhookKey]
        );

        // Save knownKeys to localStorage whenever it changes
        useEffect(() => {
          localStorage.setItem('hooklab_keys', JSON.stringify(knownKeys));
        }, [knownKeys]);

        // Sync keys from backend on page load
        useEffect(() => {
          const syncKeys = async () => {
            try {
              const res = await fetch('/api/keys');
              const data = await res.json();
              const backendKeys = data.keys || ['default'];
              setKnownKeys(backendKeys.sort());
            } catch (e) {
              // Keep localStorage keys on error
            }
          };
          syncKeys();
        }, []);

        // Merge keys from events into knownKeys
        useEffect(() => {
          const newKeys = events.map(e => e.key).filter(k => !knownKeys.includes(k));
          if (newKeys.length > 0) {
            setKnownKeys(prev => [...new Set([...prev, ...newKeys])].sort());
          }
        }, [events]);

        useEffect(() => {
          const loadInitial = async () => {
            try {
              const [eventsRes, responseRes] = await Promise.all([
                fetch(`/api/events?key=${encodeURIComponent(webhookKey)}`),
                fetch(`/api/response?key=${encodeURIComponent(webhookKey)}`),
              ]);
              const eventsData = await eventsRes.json();
              const responseData = await responseRes.json();
              setEvents(eventsData.events || []);
              setResponseBody(JSON.stringify(responseData.response, null, 2));
              if (typeof responseData.statusCode === "number") {
                setStatusCode(responseData.statusCode);
              }
              setSaveState("");
              setStatus("Live");
            } catch (error) {
              setStatus("Disconnected");
            }
          };

          loadInitial();

          const stream = new EventSource("/api/stream");
          stream.onmessage = (message) => {
            const event = JSON.parse(message.data);
            setEvents((prev) => [event, ...prev].slice(0, 50));
            setStatus("Live");
          };
          stream.onerror = () => {
            setStatus("Disconnected");
          };
          return () => stream.close();
        }, [webhookKey]);

        // Update URL when key changes
        useEffect(() => {
          const newUrl = `${window.location.pathname}?key=${encodeURIComponent(webhookKey)}`;
          window.history.replaceState({}, '', newUrl);
        }, [webhookKey]);

        useEffect(() => {
          if (window.Prism) {
            window.Prism.highlightAll();
          }
        }, [formattedEvents]);

        useEffect(() => {
          if (!cmEditorRef.current || cmInstanceRef.current) return;
          
          cmInstanceRef.current = CodeMirror(cmEditorRef.current, {
            value: responseBody,
            mode: { name: "javascript", json: true },
            theme: "material-darker",
            lineNumbers: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            tabSize: 2,
            lineWrapping: true,
          });
          
          cmInstanceRef.current.on("change", (cm) => {
            const value = cm.getValue();
            setResponseBody(value);
            try {
              JSON.parse(value);
              setJsonError("");
            } catch (err) {
              setJsonError(err.message);
            }
          });
        }, []);

        useEffect(() => {
          if (cmInstanceRef.current && cmInstanceRef.current.getValue() !== responseBody) {
            cmInstanceRef.current.setValue(responseBody);
          }
          try {
            JSON.parse(responseBody);
            setJsonError("");
          } catch (err) {
            setJsonError(err.message);
          }
        }, [responseBody]);

        const formatJson = () => {
          try {
            const parsed = JSON.parse(responseBody);
            const formatted = JSON.stringify(parsed, null, 2);
            setResponseBody(formatted);
            setJsonError("");
          } catch (err) {
            setJsonError(err.message);
          }
        };

        const handleSave = async (event) => {
          event.preventDefault();
          setSaveState("");
          try {
            JSON.parse(responseBody);
          } catch (err) {
            setSaveState("Invalid JSON");
            return;
          }

          try {
            const res = await fetch(
              `/api/response?key=${encodeURIComponent(webhookKey)}`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  response: JSON.parse(responseBody),
                  statusCode: Number(statusCode),
                }),
              }
            );
            if (!res.ok) {
              throw new Error("Failed to save");
            }
            setSaveState("Saved");
          } catch (err) {
            setSaveState("Save failed");
          }
        };

        return (
          <main className="px-6 py-10 md:px-14">
            <header className="mb-10 flex flex-col gap-6 md:flex-row md:items-center md:justify-between">
              <div>
                <p className="uppercase tracking-[0.3em] text-sm text-lagoon">
                  Webhook Monitor & API Response Mocking
                </p>
                <h1 className="font-display text-4xl md:text-5xl text-mist">
                Hook<span className="text-flare">Lab</span>
                </h1>
              </div>
              <div className="rounded-2xl border border-white/10 bg-white/5 px-6 py-4 backdrop-blur">
                <p className="text-sm text-mist/70">Status</p>
                <p className="text-2xl font-semibold text-flare">{status}</p>
                <p className="text-sm text-mist/60">
                  {events.length} event{events.length === 1 ? "" : "s"}
                </p>
              </div>
            </header>

            <section className="flex flex-col gap-6 md:flex-row">
              <div className="rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl shadow-black/30 md:w-[70%] min-w-0">
                <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
                  <h2 className="font-display text-2xl text-mist">Recent calls</h2>
                  <div className="flex flex-wrap items-center gap-2 text-xs text-mist/70">
                    <span>Webhook key</span>
                    <select
                      value={webhookKey}
                      onChange={(event) => setWebhookKey(event.target.value)}
                      className="rounded-full border border-white/10 bg-black/60 px-3 py-1 text-xs text-mist/90 outline-none focus:ring-2 focus:ring-flare"
                    >
                      {knownKeys.map((key) => (
                        <option key={key} value={key}>
                          {key}
                        </option>
                      ))}
                    </select>
                    <input
                      value={keyInput}
                      onChange={(event) => setKeyInput(event.target.value)}
                      className="w-28 rounded-full border border-white/10 bg-black/60 px-3 py-1 text-xs text-mist/90 outline-none focus:ring-2 focus:ring-flare"
                      placeholder="new key"
                    />
                    <button
                      type="button"
                      onClick={async () => {
                        const newKey = keyInput.trim();
                        if (!newKey) return;
                        // Create response config on backend to register the key
                        try {
                          await fetch(`/api/response?key=${encodeURIComponent(newKey)}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ response: { result: 'ok' }, statusCode: 200 }),
                          });
                        } catch (e) {
                          console.error('Failed to register key:', e);
                        }
                        setWebhookKey(newKey);
                        if (!knownKeys.includes(newKey)) {
                          setKnownKeys(prev => [...prev, newKey].sort());
                        }
                        setKeyInput("");
                      }}
                      className="rounded-full border border-white/10 bg-white/10 px-3 py-1 text-xs text-mist"
                    >
                      Add
                    </button>
                  </div>
                </div>
                <div className="space-y-4">
                  {formattedEvents.length === 0 ? (
                    <div className="rounded-2xl border border-dashed border-white/20 p-6 text-mist/70">
                      Send a request to <code className="text-flare">/webhook/{webhookKey}</code> to see it here.
                    </div>
                  ) : (
                    formattedEvents.map((event) => (
                      <article
                        key={event.id}
                        className="rounded-2xl border border-white/10 bg-ink/60 p-4"
                      >
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="flex flex-wrap items-center gap-2 text-xs uppercase tracking-[0.25em] text-mist/60">
                              <span className={`rounded-full border px-2 py-0.5 text-[0.65rem] font-semibold ${getMethodColor(event.method)}`}>
                                {event.method}
                              </span>
                              <span>{event.path}</span>
                            </p>
                            <p className="text-lg font-semibold text-mist">
                              {formatTime(event.timestamp)}
                            </p>
                          </div>
                          <span className="rounded-full bg-lagoon/20 px-3 py-1 text-xs text-lagoon">
                            #{event.id}
                          </span>
                        </div>
                        <pre className="mt-3 max-h-48 overflow-auto whitespace-pre-wrap break-words rounded-xl bg-black/60 p-3">
                          <code className="language-json text-mist/90">
                            {formatBody(event.body)}
                          </code>
                        </pre>
                        <div className="mt-3 rounded-xl border border-white/10 bg-white/5 p-3">
                          <p className="text-xs uppercase tracking-[0.25em] text-mist/60">
                            Headers
                          </p>
                          <ul className="mt-2 space-y-1 text-xs text-mist/70 break-words">
                            {event.headers && Object.keys(event.headers).length > 0 ? (
                              Object.entries(event.headers).map(([key, values]) => (
                                <li key={key} className="flex flex-wrap gap-2 break-all">
                                  <span className="font-semibold text-mist/80">
                                    {key}:
                                  </span>
                                  <span>{values.join(", ")}</span>
                                </li>
                              ))
                            ) : (
                              <li className="text-mist/50">No headers captured</li>
                            )}
                          </ul>
                        </div>
                      </article>
                    ))
                  )}
                </div>
              </div>

              <aside className="space-y-6 md:w-[30%] md:flex-shrink-0">
                <div className="rounded-3xl border border-white/10 bg-white/5 p-6">
                  <div className="flex items-center justify-between mb-2">
                    <h2 className="font-display text-2xl text-mist">Configure response</h2>
                    <a
                      href={`/rules.html?key=${encodeURIComponent(webhookKey)}`}
                      className="rounded-full border border-lagoon/30 bg-lagoon/10 px-3 py-1 text-xs text-lagoon hover:bg-lagoon/20"
                    >
                      ⚡ Rules
                    </a>
                  </div>
                  <p className="text-xs text-mist/50 mb-4">for <code className="text-flare">/webhook/{webhookKey}</code></p>
                  <form className="space-y-4" onSubmit={handleSave}>
                    <label className="text-sm text-mist/70">JSON response body</label>
                    <div className="flex flex-wrap items-center gap-3 text-sm text-mist/70">
                      <span>Status code</span>
                      <select
                        value={statusCode}
                        onChange={(event) => setStatusCode(Number(event.target.value))}
                        className="rounded-full border border-white/10 bg-black/60 px-3 py-1 text-sm text-mist/90 outline-none focus:ring-2 focus:ring-flare"
                      >
                        {statusOptions.map((option) => (
                          <option key={option.code} value={option.code}>
                            {option.label}
                          </option>
                        ))}
                      </select>
                    </div>
                    <div className="rounded-xl border border-white/10 bg-black/40 overflow-hidden">
                      <div ref={cmEditorRef}></div>
                      {jsonError && (
                        <div className="json-error-msg px-3 pb-2">⚠ {jsonError}</div>
                      )}
                    </div>
                    <div className="flex items-center justify-between gap-2">
                      <div className="flex gap-2">
                        <button
                          type="submit"
                          className="rounded-full bg-flare px-5 py-2 text-sm font-semibold text-ink"
                        >
                          Save
                        </button>
                        <button
                          type="button"
                          onClick={formatJson}
                          className="rounded-full border border-white/10 bg-white/10 px-4 py-2 text-sm text-mist hover:bg-white/20"
                        >
                          Format
                        </button>
                      </div>
                      <span className="text-xs text-mist/70">{saveState}</span>
                    </div>
                  </form>
                </div>

                <div className="rounded-3xl border border-white/10 bg-white/5 p-6">
                  <h2 className="font-display text-2xl text-mist mb-4">How to send</h2>
                  <div className="space-y-4 text-sm text-mist/70">
                    <p className="flex flex-wrap items-center gap-2">
                      <span>Target endpoint:</span>
                      <code className="text-flare break-all">{getBaseUrl()}/webhook/{webhookKey}</code>
                    </p>
                    <pre className="rounded-xl bg-black/40 p-4 text-xs text-mist/80 whitespace-pre-wrap break-all">
                      <code className="language-bash">{`curl -X POST -H "Content-Type: application/json" -d '{"message":"hello"}' ${getBaseUrl()}/webhook/${webhookKey}`}</code>
                    </pre>
                    <div className="rounded-2xl border border-white/10 bg-black/30 p-4">
                      <p className="font-semibold text-mist">What you see</p>
                      <ul className="mt-2 list-disc pl-5 space-y-1">
                        <li>Method, path, timestamp</li>
                        <li>Raw body captured</li>
                        <li>Realtime SSE stream</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </aside>
            </section>
          </main>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
