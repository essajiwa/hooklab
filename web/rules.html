<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HookLab - Rule Configuration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              ink: "#0c0d12",
              mist: "#eceff6",
              flare: "#ff7a59",
              lagoon: "#3ed8a6",
              night: "#121826",
            },
            fontFamily: {
              display: ["Playfair Display", "serif"],
              body: ["IBM Plex Sans", "sans-serif"],
            },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600&family=Playfair+Display:wght@500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css" />
    <style>
      .CodeMirror {
        background: transparent !important;
        color: #eceff6 !important;
        font-family: ui-monospace, monospace !important;
        font-size: 0.75rem !important;
        height: 8rem !important;
      }
      .CodeMirror-gutters {
        background: transparent !important;
        border-right: 1px solid rgba(255,255,255,0.1) !important;
      }
      .CodeMirror-linenumber {
        color: rgba(236,239,246,0.4) !important;
      }
      .CodeMirror-cursor {
        border-left-color: #ff7a59 !important;
      }
      .CodeMirror-selected {
        background: rgba(255,122,89,0.2) !important;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-ink via-night to-ink text-mist font-body">
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>

    <script type="text/babel">
      const { useEffect, useRef, useState } = React;

      function JsonEditor({ value, onChange, placeholder }) {
        const containerRef = useRef(null);
        const cmRef = useRef(null);

        useEffect(() => {
          if (!containerRef.current || cmRef.current) return;
          
          cmRef.current = CodeMirror(containerRef.current, {
            value: value || '',
            mode: { name: "javascript", json: true },
            theme: "material-darker",
            lineNumbers: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            tabSize: 2,
            lineWrapping: true,
            placeholder: placeholder,
          });
          
          cmRef.current.on("change", (cm) => {
            onChange(cm.getValue());
          });
        }, []);

        useEffect(() => {
          if (cmRef.current && cmRef.current.getValue() !== value) {
            cmRef.current.setValue(value || '');
          }
        }, [value]);

        return <div ref={containerRef} className="rounded-lg border border-white/10 bg-black/40 overflow-hidden"></div>;
      }

      const statusOptions = [
        { code: 200, label: "200 OK" },
        { code: 201, label: "201 Created" },
        { code: 202, label: "202 Accepted" },
        { code: 204, label: "204 No Content" },
        { code: 301, label: "301 Moved Permanently" },
        { code: 302, label: "302 Found" },
        { code: 304, label: "304 Not Modified" },
        { code: 400, label: "400 Bad Request" },
        { code: 401, label: "401 Unauthorized" },
        { code: 403, label: "403 Forbidden" },
        { code: 404, label: "404 Not Found" },
        { code: 409, label: "409 Conflict" },
        { code: 422, label: "422 Unprocessable Entity" },
        { code: 429, label: "429 Too Many Requests" },
        { code: 500, label: "500 Internal Server Error" },
        { code: 502, label: "502 Bad Gateway" },
        { code: 503, label: "503 Service Unavailable" },
      ];

      function RuleCard({ rule, onUpdate, onDelete, onToggle }) {
        const [isEditing, setIsEditing] = useState(false);
        const [editData, setEditData] = useState(rule);
        const [error, setError] = useState('');

        const handleSave = async () => {
          setError('');
          try {
            JSON.parse(editData.response || '{}');
          } catch (e) {
            setError('Invalid JSON in response');
            return;
          }
          
          const success = await onUpdate(rule.id, {
            ...editData,
            response: JSON.parse(editData.response || '{}'),
          });
          if (success) {
            setIsEditing(false);
          }
        };

        if (isEditing) {
          return (
            <div className="rounded-2xl border border-flare/30 bg-white/5 p-5 space-y-4">
              <div>
                <label className="text-xs text-mist/60 uppercase tracking-wider">Rule Name</label>
                <input
                  type="text"
                  value={editData.name}
                  onChange={(e) => setEditData({ ...editData, name: e.target.value })}
                  className="mt-1 w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-mist outline-none focus:border-flare"
                  placeholder="e.g., High Value Payment"
                />
              </div>
              
              <div>
                <label className="text-xs text-mist/60 uppercase tracking-wider">Condition Expression</label>
                <input
                  type="text"
                  value={editData.condition}
                  onChange={(e) => setEditData({ ...editData, condition: e.target.value })}
                  className="mt-1 w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-mist font-mono outline-none focus:border-flare"
                  placeholder='e.g., body.amount > 100 && body.currency == "USD"'
                />
                <p className="mt-1 text-xs text-mist/40">
                  Available: <code className="text-lagoon">body</code>, <code className="text-lagoon">method</code>, <code className="text-lagoon">headers</code>
                </p>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-xs text-mist/60 uppercase tracking-wider">Status Code</label>
                  <select
                    value={editData.statusCode}
                    onChange={(e) => setEditData({ ...editData, statusCode: parseInt(e.target.value) })}
                    className="mt-1 w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-mist outline-none focus:border-flare"
                  >
                    {statusOptions.map((opt) => (
                      <option key={opt.code} value={opt.code}>{opt.label}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="text-xs text-mist/60 uppercase tracking-wider">Priority</label>
                  <input
                    type="number"
                    value={editData.priority}
                    onChange={(e) => setEditData({ ...editData, priority: parseInt(e.target.value) || 0 })}
                    className="mt-1 w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-mist outline-none focus:border-flare"
                  />
                  <p className="mt-1 text-xs text-mist/40">Lower = higher priority</p>
                </div>
              </div>

              <div>
                <label className="text-xs text-mist/60 uppercase tracking-wider">Response Body (JSON)</label>
                <JsonEditor
                  value={typeof editData.response === 'string' ? editData.response : JSON.stringify(editData.response, null, 2)}
                  onChange={(val) => setEditData({ ...editData, response: val })}
                />
              </div>

              {error && <p className="text-red-400 text-sm">{error}</p>}

              <div className="flex gap-2">
                <button
                  onClick={handleSave}
                  className="rounded-full bg-flare px-4 py-2 text-sm font-semibold text-ink"
                >
                  Save
                </button>
                <button
                  onClick={() => { setIsEditing(false); setEditData(rule); }}
                  className="rounded-full border border-white/10 px-4 py-2 text-sm text-mist hover:bg-white/10"
                >
                  Cancel
                </button>
              </div>
            </div>
          );
        }

        return (
          <div className={`rounded-2xl border ${rule.enabled ? 'border-lagoon/30' : 'border-white/10'} bg-white/5 p-5`}>
            <div className="flex items-start justify-between gap-4">
              <div className="flex-1 min-w-0">
                <div className="flex items-center gap-3">
                  <h3 className="font-semibold text-mist truncate">{rule.name || 'Unnamed Rule'}</h3>
                  <span className={`rounded-full px-2 py-0.5 text-xs ${rule.enabled ? 'bg-lagoon/20 text-lagoon' : 'bg-white/10 text-mist/50'}`}>
                    {rule.enabled ? 'Active' : 'Disabled'}
                  </span>
                  <span className="rounded-full bg-white/10 px-2 py-0.5 text-xs text-mist/60">
                    Priority: {rule.priority}
                  </span>
                </div>
                <p className="mt-2 font-mono text-sm text-flare/80 break-all">{rule.condition}</p>
                <div className="mt-3 flex items-center gap-4 text-xs text-mist/50">
                  <span>Status: <code className="text-lagoon">{rule.statusCode}</code></span>
                  <span>Response: <code className="text-mist/70">{JSON.stringify(rule.response).slice(0, 50)}...</code></span>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <button
                  onClick={() => onToggle(rule.id, !rule.enabled)}
                  className={`rounded-full px-3 py-1 text-xs ${rule.enabled ? 'bg-lagoon/20 text-lagoon hover:bg-lagoon/30' : 'bg-white/10 text-mist/60 hover:bg-white/20'}`}
                >
                  {rule.enabled ? 'Disable' : 'Enable'}
                </button>
                <button
                  onClick={() => setIsEditing(true)}
                  className="rounded-full bg-white/10 px-3 py-1 text-xs text-mist hover:bg-white/20"
                >
                  Edit
                </button>
                <button
                  onClick={() => onDelete(rule.id)}
                  className="rounded-full bg-red-500/20 px-3 py-1 text-xs text-red-400 hover:bg-red-500/30"
                >
                  Delete
                </button>
              </div>
            </div>
          </div>
        );
      }

      function App() {
        const [webhookKey, setWebhookKey] = useState(() => {
          const params = new URLSearchParams(window.location.search);
          return params.get('key') || 'default';
        });
        const [keyInput, setKeyInput] = useState(webhookKey);
        const [rules, setRules] = useState([]);
        const [loading, setLoading] = useState(true);
        const [showNewRule, setShowNewRule] = useState(false);
        const [newRule, setNewRule] = useState({
          name: '',
          condition: '',
          response: '{\n  "status": "matched"\n}',
          statusCode: 200,
          priority: 0,
          enabled: true,
        });
        const [error, setError] = useState('');

        const loadRules = async () => {
          setLoading(true);
          try {
            const res = await fetch(`/api/rules?key=${encodeURIComponent(webhookKey)}`);
            const data = await res.json();
            setRules(data.rules || []);
          } catch (e) {
            console.error('Failed to load rules:', e);
          }
          setLoading(false);
        };

        useEffect(() => {
          loadRules();
          const newUrl = `${window.location.pathname}?key=${encodeURIComponent(webhookKey)}`;
          window.history.replaceState({}, '', newUrl);
        }, [webhookKey]);

        const handleKeyChange = () => {
          if (keyInput.trim()) {
            setWebhookKey(keyInput.trim());
          }
        };

        const createRule = async () => {
          setError('');
          try {
            JSON.parse(newRule.response);
          } catch (e) {
            setError('Invalid JSON in response');
            return;
          }

          const res = await fetch(`/api/rules?key=${encodeURIComponent(webhookKey)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ...newRule,
              response: JSON.parse(newRule.response),
            }),
          });

          if (res.ok) {
            setShowNewRule(false);
            setNewRule({
              name: '',
              condition: '',
              response: '{\n  "status": "matched"\n}',
              statusCode: 200,
              priority: 0,
              enabled: true,
            });
            loadRules();
          } else {
            const data = await res.json();
            setError(data.error || 'Failed to create rule');
          }
        };

        const updateRule = async (ruleId, data) => {
          const res = await fetch(`/api/rules?key=${encodeURIComponent(webhookKey)}&id=${ruleId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
          if (res.ok) {
            loadRules();
            return true;
          }
          return false;
        };

        const deleteRule = async (ruleId) => {
          if (!confirm('Delete this rule?')) return;
          const res = await fetch(`/api/rules?key=${encodeURIComponent(webhookKey)}&id=${ruleId}`, {
            method: 'DELETE',
          });
          if (res.ok) {
            loadRules();
          }
        };

        const toggleRule = async (ruleId, enabled) => {
          const rule = rules.find(r => r.id === ruleId);
          if (rule) {
            await updateRule(ruleId, { ...rule, enabled });
          }
        };

        return (
          <main className="px-6 py-10 md:px-14 max-w-6xl mx-auto">
            <header className="mb-10">
              <div className="flex items-center gap-4 mb-6">
                <a href="/" className="text-mist/60 hover:text-mist text-sm">‚Üê Back to Monitor</a>
              </div>
              <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div>
                  <p className="uppercase tracking-[0.3em] text-sm text-lagoon">Rule Configuration</p>
                  <h1 className="font-display text-4xl md:text-5xl text-mist">
                    Hook<span className="text-flare">Lab</span>
                  </h1>
                </div>
                <div className="flex items-center gap-3">
                  <input
                    type="text"
                    value={keyInput}
                    onChange={(e) => setKeyInput(e.target.value)}
                    onKeyDown={(e) => e.key === 'Enter' && handleKeyChange()}
                    className="rounded-full border border-white/10 bg-black/40 px-4 py-2 text-sm text-mist outline-none focus:border-flare"
                    placeholder="Webhook key"
                  />
                  <button
                    onClick={handleKeyChange}
                    className="rounded-full bg-flare px-4 py-2 text-sm font-semibold text-ink"
                  >
                    Load
                  </button>
                </div>
              </div>
              <p className="mt-4 text-mist/60">
                Configure conditional responses for <code className="text-flare">/webhook/{webhookKey}</code>
              </p>
            </header>

            <div className="rounded-3xl border border-white/10 bg-white/5 p-6 mb-6">
              <div className="flex items-center justify-between mb-4">
                <h2 className="font-display text-xl text-mist">Expression Syntax</h2>
                <a
                  href="https://github.com/essajiwa/hooklab/blob/main/RULES.md"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-xs text-lagoon hover:text-lagoon/80"
                >
                  üìñ Full Documentation ‚Üí
                </a>
              </div>
              <div className="grid md:grid-cols-2 gap-4 text-sm">
                <div className="space-y-2">
                  <p className="text-mist/70">Available variables:</p>
                  <ul className="space-y-1 text-mist/50">
                    <li><code className="text-lagoon">body</code> ‚Äî Parsed JSON body (or raw string)</li>
                    <li><code className="text-lagoon">method</code> ‚Äî HTTP method (GET, POST, etc.)</li>
                    <li><code className="text-lagoon">headers</code> ‚Äî Request headers map</li>
                  </ul>
                </div>
                <div className="space-y-2">
                  <p className="text-mist/70">Example expressions:</p>
                  <ul className="space-y-1 font-mono text-xs text-flare/70">
                    <li>body.amount &gt; 100</li>
                    <li>body.type == "payment" && body.status == "pending"</li>
                    <li>method == "POST" && body.action in ["create", "update"]</li>
                    <li>"Authorization" in headers</li>
                  </ul>
                </div>
              </div>
            </div>

            <div className="flex items-center justify-between mb-6">
              <h2 className="font-display text-2xl text-mist">
                Rules <span className="text-mist/40">({rules.length})</span>
              </h2>
              <button
                onClick={() => setShowNewRule(true)}
                className="rounded-full bg-lagoon px-5 py-2 text-sm font-semibold text-ink"
              >
                + Add Rule
              </button>
            </div>

            {showNewRule && (
              <div className="rounded-2xl border border-lagoon/30 bg-white/5 p-5 mb-6 space-y-4">
                <h3 className="font-semibold text-lagoon">New Rule</h3>
                
                <div>
                  <label className="text-xs text-mist/60 uppercase tracking-wider">Rule Name</label>
                  <input
                    type="text"
                    value={newRule.name}
                    onChange={(e) => setNewRule({ ...newRule, name: e.target.value })}
                    className="mt-1 w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-mist outline-none focus:border-lagoon"
                    placeholder="e.g., High Value Payment"
                  />
                </div>
                
                <div>
                  <label className="text-xs text-mist/60 uppercase tracking-wider">Condition Expression</label>
                  <input
                    type="text"
                    value={newRule.condition}
                    onChange={(e) => setNewRule({ ...newRule, condition: e.target.value })}
                    className="mt-1 w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-mist font-mono outline-none focus:border-lagoon"
                    placeholder='e.g., body.amount > 100 && body.currency == "USD"'
                  />
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-xs text-mist/60 uppercase tracking-wider">Status Code</label>
                    <select
                      value={newRule.statusCode}
                      onChange={(e) => setNewRule({ ...newRule, statusCode: parseInt(e.target.value) })}
                      className="mt-1 w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-mist outline-none focus:border-lagoon"
                    >
                      {statusOptions.map((opt) => (
                        <option key={opt.code} value={opt.code}>{opt.label}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="text-xs text-mist/60 uppercase tracking-wider">Priority</label>
                    <input
                      type="number"
                      value={newRule.priority}
                      onChange={(e) => setNewRule({ ...newRule, priority: parseInt(e.target.value) || 0 })}
                      className="mt-1 w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-mist outline-none focus:border-lagoon"
                    />
                  </div>
                </div>

                <div>
                  <label className="text-xs text-mist/60 uppercase tracking-wider">Response Body (JSON)</label>
                  <JsonEditor
                    value={newRule.response}
                    onChange={(val) => setNewRule({ ...newRule, response: val })}
                  />
                </div>

                <div className="flex items-center gap-3">
                  <label className="flex items-center gap-2 text-sm text-mist/70">
                    <input
                      type="checkbox"
                      checked={newRule.enabled}
                      onChange={(e) => setNewRule({ ...newRule, enabled: e.target.checked })}
                      className="rounded"
                    />
                    Enabled
                  </label>
                </div>

                {error && <p className="text-red-400 text-sm">{error}</p>}

                <div className="flex gap-2">
                  <button
                    onClick={createRule}
                    className="rounded-full bg-lagoon px-4 py-2 text-sm font-semibold text-ink"
                  >
                    Create Rule
                  </button>
                  <button
                    onClick={() => setShowNewRule(false)}
                    className="rounded-full border border-white/10 px-4 py-2 text-sm text-mist hover:bg-white/10"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            )}

            {loading ? (
              <div className="text-center py-12 text-mist/50">Loading rules...</div>
            ) : rules.length === 0 ? (
              <div className="text-center py-12 rounded-2xl border border-dashed border-white/10">
                <p className="text-mist/50 mb-4">No rules configured for this webhook key</p>
                <p className="text-mist/30 text-sm">Rules are evaluated in priority order. First matching rule wins.</p>
              </div>
            ) : (
              <div className="space-y-4">
                {rules.map((rule) => (
                  <RuleCard
                    key={rule.id}
                    rule={rule}
                    onUpdate={updateRule}
                    onDelete={deleteRule}
                    onToggle={toggleRule}
                  />
                ))}
              </div>
            )}
          </main>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
